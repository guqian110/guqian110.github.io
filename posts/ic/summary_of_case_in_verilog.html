
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="index, follow" />

  <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro|Source+Sans+Pro:300,400,400i,700" rel="stylesheet">

    <link rel="stylesheet" type="text/css" href="../../theme/stylesheet/style.min.css">

    <link id="dark-theme-style" rel="stylesheet" type="text/css"
          media="(prefers-color-scheme: dark)"
    href="../../theme/stylesheet/dark-theme.min.css">

    <link id="pygments-dark-theme" rel="stylesheet" type="text/css"
              media="(prefers-color-scheme: dark)"
          href="../../theme/pygments/monokai.min.css">
    <link id="pygments-light-theme" rel="stylesheet" type="text/css"
              media="(prefers-color-scheme: light), (prefers-color-scheme: no-preference)"
          href="../../theme/pygments/monokai.min.css">

    <script src="../../theme/tipuesearch/jquery.min.js"></script>
    <script src="../../theme/tipuesearch/tipuesearch.min.js"></script>
    <script src="../../theme/tipuesearch/tipuesearch.min.js"></script>
    <script src="../../theme/tipuesearch/tipuesearch_set.min.js"></script>
    <script src="../../tipuesearch_content.js"></script>
    <link rel="stylesheet" href="../../theme/tipuesearch/tipuesearch.min.css" />

  <link rel="stylesheet" type="text/css" href="../../theme/font-awesome/css/fontawesome.css">
  <link rel="stylesheet" type="text/css" href="../../theme/font-awesome/css/brands.css">
  <link rel="stylesheet" type="text/css" href="../../theme/font-awesome/css/solid.css">


    <link href="/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Qian's Blog Atom">


    <link rel="shortcut icon" href="/images/favicon_64x64.ico" type="image/x-icon">
    <link rel="icon" href="/images/favicon_64x64.ico" type="image/x-icon">

<!-- Google Analytics -->
<script type="text/javascript">
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-48826831-1', 'auto');
  ga('send', 'pageview');
</script>
<!-- End Google Analytics -->
    <!-- Chrome, Firefox OS and Opera -->
    <meta name="theme-color" content="#333333">
    <!-- Windows Phone -->
    <meta name="msapplication-navbutton-color" content="#333333">
    <!-- iOS Safari -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Microsoft EDGE -->
    <meta name="msapplication-TileColor" content="#333333">

<meta name="author" content="Qian Gu" />
<meta name="description" content="总结 case 的用法和需要注意的细节" />
<meta name="keywords" content="case">


<meta property="og:site_name" content="Qian's Blog"/>
<meta property="og:title" content="Verilog 的 case 小结"/>
<meta property="og:description" content="总结 case 的用法和需要注意的细节"/>
<meta property="og:locale" content="en"/>
<meta property="og:url" content="../../posts/ic/summary_of_case_in_verilog.html"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2015-04-15 15:50:00+08:00"/>
<meta property="article:modified_time" content=""/>
<meta property="article:author" content="../../author/qian-gu.html">
<meta property="article:section" content="IC"/>
<meta property="article:tag" content="case"/>
<meta property="og:image" content="/images/logo.png">

  <title>Qian's Blog &ndash; Verilog 的 case 小结</title>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({
      google_ad_client: "ca-pub-1821536199377100",
      enable_page_level_ads: true
    });
  </script>
</head>
<body >
  <aside>
    <div>
      <a href="../..">
        <img src="/images/logo.png" alt="Qian Gu" title="Qian Gu">
      </a>

      <h1>
        <a href="../..">Qian Gu</a>
      </h1>

<p>Read >> Think >> Write</p>
        <form class="navbar-search" action="/search.html" role="search">
          <input type="text" name="q" id="tipue_search_input" placeholder="Search...">
        </form>

      <nav>
        <ul class="list">


              <li>
                <a target="_blank"
                   href="../../pages/about-me.html#about-me">
                  About Me
                </a>
              </li>

        </ul>
      </nav>

      <ul class="social">
          <li>
            <a  class="sc-envelope" href="mailto:guqian110@163.com" target="_blank">
              <i class="fas fa-envelope"></i>
            </a>
          </li>
          <li>
            <a  class="sc-github" href="https://github.com/guqian110" target="_blank">
              <i class="fab fa-github"></i>
            </a>
          </li>
          <li>
            <a  class="sc-twitter" href="https://twitter.com/qian_gu" target="_blank">
              <i class="fab fa-twitter"></i>
            </a>
          </li>
          <li>
            <a  class="sc-rss" href="/feeds/all.atom.xml" target="_blank">
              <i class="fas fa-rss"></i>
            </a>
          </li>
      </ul>
    </div>

  </aside>
  <main>

    <nav>
      <a href="../..">Home</a>

      <a href="/authors.html">Authors</a>
      <a href="/archives.html">Archives</a>
      <a href="/categories.html">Categories</a>
      <a href="/tags.html">Tags</a>

      <a href="/feeds/all.atom.xml">Atom</a>

    </nav>

<article class="single">
  <header>
      
    <h1 id="summary_of_case_in_verilog">Verilog 的 case 小结</h1>
    <p>
      Posted on 2015-04-15 15:50 in <a href="../../category/ic.html">IC</a>

    </p>
  </header>


  <div class="col-lg-3 hidden-xs hidden-sm">
        <div id="toc"><ul><li><a class="toc-href" href="#" title="Verilog 的 case 小结">Verilog 的 case 小结</a><ul><li><a class="toc-href" href="#def" title="Def">Def</a><ul><li><a class="toc-href" href="#syntax:" title="Syntax:">Syntax:</a></li><li><a class="toc-href" href="#case statement header" title="Case statement header">Case statement header</a></li><li><a class="toc-href" href="#case expression" title="Case expression">Case expression</a></li><li><a class="toc-href" href="#case item" title="Case item">Case item</a></li><li><a class="toc-href" href="#case item statement" title="Case item statement">Case item statement</a></li><li><a class="toc-href" href="#case default" title="Case default">Case default</a></li><li><a class="toc-href" href="#casez" title="Casez">Casez</a></li><li><a class="toc-href" href="#casex" title="casex">casex</a></li><li><a class="toc-href" href="#process" title="Process">Process</a></li><li><a class="toc-href" href="#reverse case" title="reverse case">reverse case</a></li></ul></li><li><a class="toc-href" href='#"full" case statement_1' title='"full" case statement'>"full" case statement</a><ul><li><a class="toc-href" href="#hdl full case" title="HDL full case">HDL full case</a></li><li><a class="toc-href" href="#synthesis full case" title="Synthesis full case">Synthesis full case</a></li><li><a class="toc-href" href="#xst full case" title="XST full case">XST full case</a></li></ul></li><li><a class="toc-href" href='#"parallel" case statement_1' title='"parallel" case statement'>"parallel" case statement</a><ul><li><a class="toc-href" href="#non-parallel case statements" title="Non-parallel case statements">Non-parallel case statements</a></li><li><a class="toc-href" href="#parallel case statements" title="Parallel case statements">Parallel case statements</a></li><li><a class="toc-href" href="#xst parallel case" title="XST parallel case">XST parallel case</a></li></ul></li><li><a class="toc-href" href="#synthesis coding styles_1" title="Synthesis coding styles">Synthesis coding styles</a></li><li><a class="toc-href" href="#summary" title="Summary">Summary</a></li><li><a class="toc-href" href="#ref" title="Ref">Ref</a></li></ul></li></ul></div>
  </div>

  <div>
    <p>学习了 Cummings 大神 的 paper：<a href="http://www.sunburst-design.com/papers/CummingsSNUG1999Boston_FullParallelCase.pdf">"full_case parallel_case", the Evil Twins of Verilog Synthesis</a> 和 <a href="http://www.phei.com.cn/module/goods/wssd_content.jsp?bookid=38848">Verilog 编程艺术</a></p>
<p>总结一下笔记。</p>
<h2 id="def">Def</h2>
<hr/>
<h3 id="syntax:">Syntax:</h3>
<div class="highlight"><pre><span></span><span class="k">case</span> <span class="p">(</span><span class="n">case_expression</span><span class="p">)</span>
 <span class="n">case_item1</span> <span class="p">:</span> <span class="n">case_item_statement1</span><span class="p">;</span>
 <span class="n">case_item2</span> <span class="p">:</span> <span class="n">case_item_statement2</span><span class="p">;</span>
 <span class="n">case_item3</span> <span class="p">:</span> <span class="n">case_item_statement3</span><span class="p">;</span>
 <span class="n">case_item4</span> <span class="p">:</span> <span class="n">case_item_statement4</span><span class="p">;</span>
 <span class="k">default</span> <span class="p">:</span> <span class="n">case_item_statement5</span><span class="p">;</span>
<span class="n">endcase</span>
</pre></div>
<p>等价于</p>
<div class="highlight"><pre><span></span><span class="k">if</span> <span class="ss">(</span><span class="nv">case_expression</span> <span class="o">===</span> <span class="nv">case_item1</span><span class="ss">)</span> <span class="nv">case_item_statement1</span><span class="c1">;</span>
<span class="k">else</span> <span class="k">if</span> <span class="ss">(</span><span class="nv">case_expression</span> <span class="o">===</span> <span class="nv">case_item2</span><span class="ss">)</span> <span class="nv">case_item_statement2</span><span class="c1">;</span>
<span class="k">else</span> <span class="k">if</span> <span class="ss">(</span><span class="nv">case_expression</span> <span class="o">===</span> <span class="nv">case_item3</span><span class="ss">)</span> <span class="nv">case_item_statement3</span><span class="c1">;</span>
<span class="k">else</span> <span class="k">if</span> <span class="ss">(</span><span class="nv">case_expression</span> <span class="o">===</span> <span class="nv">case_item4</span><span class="ss">)</span> <span class="nv">case_item_statement4</span><span class="c1">;</span>
<span class="k">else</span>                                     <span class="nv">case_item_statement5</span><span class="c1">;</span>
</pre></div>
<p>首先说明一些基本名词的定义：</p>
<h3 id="case statement header">Case statement header</h3>
<p>header 由 关键字 <code>case</code>/<code>casex</code>/<code>casez</code> + case expression 两部分组成，它们通常写在同一行（上面语法的第一行）。添加 "parallel_case" 或者 "full_case" 综合指令的方法就是把指令当作注释写在 header 的那一行，后续 case item 之前。</p>
<h3 id="case expression">Case expression</h3>
<p><code>case</code> 关键字之后，括号中间的内容。它可以是一个常量（如 '1'），也可以是一个表达式，或者更常见的一个 1 bit / n bits 的向量，用来和后面的 case item 做比较。</p>
<h3 id="case item">Case item</h3>
<p>可以是单比特、向量、表达式，用来和 case expression 做比较。和高级编程语言（C 语言）不同的是，verilog 中的 case 自带隐含的 <code>break</code> 语句，所以就不用再费心多写代码了。</p>
<h3 id="case item statement">Case item statement</h3>
<p>case item 内的语句，多于 1 句时，要用 <code>begin-end</code>。</p>
<h3 id="case default">Case default</h3>
<p>默认分支，虽然这个分支不是强制要求的，但是在所有分支后面加上 default 分支是一个良好的编程习惯。</p>
<h3 id="casez">Casez</h3>
<p>case 语句的变种，casez 把 expression 或者是 item 中的 "z"/"?" 忽略，当作不关心的值。</p>
<blockquote>
<p><strong>Guideline:</strong> Exercise caution when coding synthesizable models using the Verilog casez statement</p>
<p><strong>Coding Style Guideline:</strong> When coding a case statement with "don't cares," use a casez statement
and use "?" characters instead of "z" characters in the case items to indicate "don't care" bits.</p>
</blockquote>
<h3 id="casex">casex</h3>
<p>类似于 casez，不关心的值为 "z" / "?" / "x"。</p>
<blockquote>
<p><strong>Guideline:</strong> Do not use casex for synthesizable code</p>
</blockquote>
<h3 id="process">Process</h3>
<p>case 的执行过程：</p>
<ol>
<li>
<p>计算 case expression，只计算一次，然后按照代码顺序从上向下和 case item 逐个比较</p>
</li>
<li>
<p>比较过程中，如果有 default 分支，则暂时先忽略</p>
</li>
<li>
<p>如果有某个 item 和 expression 匹配，则执行此 item 下的语句</p>
</li>
<li>
<p>如果匹配失败，有 default 分支，则执行该 default 分支</p>
</li>
<li>
<p>如果匹配失败，没有 default 分支，则终止</p>
</li>
</ol>
<p>这个按照顺序比较的过程就是可能导致 priority encoder 的原因。</p>
<h3 id="reverse case">reverse case</h3>
<p>reverse case 是 case 的一个变形，也叫做 <code>case if true</code>。这种风格中 case expression 是一个常量，而 case items 是由变量构成的表达式。这种风格通常用在 One-hot FSM 中，并且采用 parallel 方式。</p>
<p>见另外一篇博客：<a href="http://guqian110.github.io/pages/2014/06/05/fsm_design.html">有限状态机设计</a></p>
<p><br/></p>
<p>下面讨论 full_case 和 parallel_case 的相关问题。很多人都会使用这两个综合指令，他们的理由是：</p>
<blockquote>
<ul>
<li>
<p>"full_case parallel_case" makes my designs smaller and faster.</p>
</li>
<li>
<p>"full_case" removes latches from my designs.</p>
</li>
<li>
<p>"parallel_case" removes large, slow priority encoders from my designs.</p>
</li>
</ul>
</blockquote>
<p>然而这些理由都不够准确或者说是危险的，因为这两个综合指令有时候完全不影响设计，有时候反而会使设计速度变慢、面积变大，有时候甚至会改变设计的功能。<strong>通常，这些指令都很危险。</strong> 所以，Cummings 给他的 paper 起了如下的别名 ...</p>
<blockquote>
<p>An alternate title for this paper could be: "How to add $200,000 to the cost and 3-6 months to the schedule of your ASIC design without trying!"</p>
</blockquote>
<p><br/></p>
<h2 id='"full" case statement_1'>"full" case statement</h2>
<hr/>
<p>"full" 的意思就是 expression 的任何取值都有一个 item/default 分支与其对应，否者就不是 "full case"。</p>
<p><strong>example1: Non-"full" case</strong></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">module</span> <span class="n">mux3a</span> <span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">sel</span><span class="p">);</span>
    <span class="k">output</span> <span class="n">y</span><span class="p">;</span>
    <span class="k">input</span> <span class="p">[</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">sel</span><span class="p">;</span>
    <span class="k">input</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">;</span>
    <span class="kt">reg</span> <span class="n">y</span><span class="p">;</span>

    <span class="k">always</span> <span class="p">@</span><span class="o">*</span> <span class="k">begin</span>
        <span class="k">case</span> <span class="p">(</span><span class="n">sel</span><span class="p">)</span>
            <span class="mh">2</span><span class="mb">'b00</span><span class="o">:</span> <span class="n">y</span> <span class="o">=</span> <span class="n">a</span><span class="p">;</span>
            <span class="mh">2</span><span class="mb">'b01</span><span class="o">:</span> <span class="n">y</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>
            <span class="mh">2</span><span class="mb">'b10</span><span class="o">:</span> <span class="n">y</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
        <span class="k">endcase</span>
    <span class="k">end</span>

<span class="k">endmodule</span>
</pre></div>
</td></tr></table>
<p>在这个例子中，当 sel 的取值是 2'b11 时，由于没有定义输出值 y 为多少，仿真器会保持之前的取值，综合器会综合出一个 latch。</p>
<p>（基于 Virtex-4 器件，XST 的 synthesis report 给出的结果是 1 bit latch + 1 bit 3-to-1 multiplexers）</p>
<h3 id="hdl full case">HDL full case</h3>
<p>从 HDL 仿真器的角度看，full case 语句就是 case item 包含了 expression 可以取的任何值。</p>
<h3 id="synthesis full case">Synthesis full case</h3>
<p>从综合工具的角度看，full case 语句就是 expression 的每种可能的取值组合都被包含在 item 中。</p>
<p>虽然 Verilog 语法不要求 case 语句必须是 HDL full 或者 synthesis full ，但是我们可以通过手动添加一个 default 分支来使得 case 变为 full。</p>
<p><strong>example2: "full" case</strong></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">module</span> <span class="n">mux3a</span> <span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">sel</span><span class="p">);</span>
    <span class="k">output</span> <span class="n">y</span><span class="p">;</span>
    <span class="k">input</span> <span class="p">[</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">sel</span><span class="p">;</span>
    <span class="k">input</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">;</span>
    <span class="kt">reg</span> <span class="n">y</span><span class="p">;</span>

    <span class="k">always</span> <span class="p">@</span><span class="o">*</span> <span class="k">begin</span>
        <span class="k">case</span> <span class="p">(</span><span class="n">sel</span><span class="p">)</span>
            <span class="mh">2</span><span class="mb">'b00</span><span class="o">:</span> <span class="n">y</span> <span class="o">=</span> <span class="n">a</span><span class="p">;</span>
            <span class="mh">2</span><span class="mb">'b01</span><span class="o">:</span> <span class="n">y</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>
            <span class="mh">2</span><span class="mb">'b10</span><span class="o">:</span> <span class="n">y</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
            <span class="k">default</span><span class="o">:</span> <span class="n">y</span> <span class="o">=</span> <span class="mh">1</span><span class="p">'</span><span class="n">bx</span><span class="p">;</span>
        <span class="k">endcase</span>

<span class="k">endmodule</span>
</pre></div>
</td></tr></table>
<p>在这个例子中，因为有了 default 分支，所以它是一个 full case。在仿真时，如果 sel 是 2'b11，那么 y 取值为 x（不确定，unknown），而综合器会把 x 当作 &ldquo; 不关心 &rdquo;（don't care，有可能为 1，也有可能为 0）。这就导致了仿真和综合不一致。解决这个问题的方法就是给 y 赋值一个常数 or 像其他 item 一样赋值一个输入。</p>
<p>（基于 Virtex-4 器件，XST 的 synthesis report 给出的结果是 1 bit 3-to-1 multiplexers）</p>
<p>P.S. 我们可以利用前后仿真不同这一点来帮助我们调试。在设计 FSM 时，default 分支处，next_state 赋值为 x，这样如果存在错误转换，next_state 就会保持为 x，在波形上很方便看到。</p>
<p>还有一种方法是在所有的 item 之前，给输出赋一个默认值，这样即使不是 full，也不会产生 latch：</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">always</span> <span class="p">@(</span><span class="n">a</span> <span class="k">or</span> <span class="n">b</span> <span class="k">or</span> <span class="n">c</span> <span class="k">or</span> <span class="n">sel</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="mh">1</span><span class="mb">'b0</span><span class="p">;</span>
    <span class="k">case</span> <span class="p">(</span><span class="n">sel</span><span class="p">)</span>
        <span class="mh">2</span><span class="mb">'b00</span><span class="o">:</span> <span class="n">y</span> <span class="o">=</span> <span class="n">a</span><span class="p">;</span>
        <span class="mh">2</span><span class="mb">'b01</span><span class="o">:</span> <span class="n">y</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>
        <span class="mh">2</span><span class="mb">'b10</span><span class="o">:</span> <span class="n">y</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
    <span class="k">endcase</span>
</pre></div>
</td></tr></table>
<h3 id="xst full case">XST full case</h3>
<p>综合指令是一些特殊的可以被综合工具识别，并指导综合工具工作的语句。不同的综合工具的综合指令语法不相同。我用的是 ISE 自带的 XST。查看 XST User Guide 就可以找到 full case 的相关指令：</p>
<p>这个指令与架构（Architecture）无关、只适用于 verilog 的 case 语句：</p>
<ul>
<li>
<p>只对 Verilog 有效</p>
</li>
<li>
<p>标识所有的取值都被包含在 item 中</p>
</li>
<li>
<p>阻止 XST 对那些没有被包含的情况生成额外的电路</p>
</li>
</ul>
<p>使用这个指令的方法有很多：</p>
<ol>
<li>
<p><strong>Verilog Syntax</strong></p>
<div class="highlight"><pre><span></span><span class="c">(* full_case *)</span>
</pre></div>
<p>在 case header 的上面一行</p>
<p>or</p>
<div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">synthesis</span> <span class="n">full_case</span>
</pre></div>
<p>这种方式，注释必须在 case header 的同一行</p>
<p>example3:</p>
<div class="highlight"><pre><span></span><span class="c">(* full_case *)</span>
<span class="n">casex</span> <span class="n">select</span>
    <span class="mi">4</span><span class="err">&rsquo;</span><span class="n">b1xxx</span><span class="o">:</span> <span class="n">res</span> <span class="o">=</span> <span class="n">data1</span><span class="o">;</span>
    <span class="mi">4</span><span class="err">&rsquo;</span><span class="n">bx1xx</span><span class="o">:</span> <span class="n">res</span> <span class="o">=</span> <span class="n">data2</span><span class="o">;</span>
    <span class="mi">4</span><span class="err">&rsquo;</span><span class="n">bxx1x</span><span class="o">:</span> <span class="n">res</span> <span class="o">=</span> <span class="n">data3</span><span class="o">;</span>
    <span class="mi">4</span><span class="err">&rsquo;</span><span class="n">bxxx1</span><span class="o">:</span> <span class="n">res</span> <span class="o">=</span> <span class="n">data4</span><span class="o">;</span>
<span class="n">endcase</span>
</pre></div>
<p>example4:</p>
<div class="highlight"><pre><span></span><span class="nt">casex</span> <span class="nt">select</span> <span class="o">//</span> <span class="nt">synthesis</span> <span class="nt">full_case</span>
    <span class="nt">4</span><span class="err">&rsquo;</span><span class="nt">b1xxx</span><span class="o">:</span> <span class="nt">res</span> <span class="o">=</span> <span class="nt">data1</span><span class="o">;</span>
    <span class="nt">4</span><span class="err">&rsquo;</span><span class="nt">bx1xx</span><span class="o">:</span> <span class="nt">res</span> <span class="o">=</span> <span class="nt">data2</span><span class="o">;</span>
    <span class="nt">4</span><span class="err">&rsquo;</span><span class="nt">bxx1x</span><span class="o">:</span> <span class="nt">res</span> <span class="o">=</span> <span class="nt">data3</span><span class="o">;</span>
    <span class="nt">4</span><span class="err">&rsquo;</span><span class="nt">bxxx1</span><span class="o">:</span> <span class="nt">res</span> <span class="o">=</span> <span class="nt">data4</span><span class="o">;</span>
<span class="nt">endcase</span>
</pre></div>
</li>
<li>
<p>XST Command Line</p>
<div class="highlight"><pre><span></span><span class="n">xst</span> <span class="n">run</span> <span class="o">-</span><span class="n">vlgcase</span> <span class="p">[</span><span class="k">full</span><span class="o">|</span><span class="n">parallel</span><span class="o">|</span><span class="k">full</span><span class="o">-</span><span class="n">parallel</span><span class="p">]</span>
</pre></div>
</li>
<li>
<p>ISE Design Suit</p>
<p>Process &gt; Process Properties &gt; Synthesis Options &gt; Full Case.</p>
</li>
</ol>
<p>在 XST User Guide 中：</p>
<blockquote>
<p>XST automatically determines the characteristics of the case statements and generates
logic using multiplexers, priority encoders, and latches that best implement the exact
behavior of the case statement.</p>
</blockquote>
<p>也就是说，如果我们不添加综合指令，XST 会根据代码自动判断，选择 MUX、priority encoder、latch 来生成最合适的实现电路。</p>
<ol>
<li>
<p>如果生成 MUX，那么 synthesis report 在 Macro Recognition 步骤中会给出 MUX  macro 的内容</p>
<p>注意，XST 是否会把 case 推译成 MUX，还取决于器件。对于 LUT4-based 器件，如果输入端口是 4 个，输出是 1 个，那么就会推译出 MUX；对于 LUT6-based 的器件，如 Virtex-5，那么需要输入端口是 8 个以上。</p>
</li>
<li>
<p>如果生成 Latch，那么 synthesis report 会给出 warning（只要生成 latch，不管是设计有意还是设计失误无意产生的，都会给出 warning，毕竟 latch 是很容易导致错误的）</p>
</li>
</ol>
<p>如上面的例子，如果改成</p>
<div class="highlight"><pre><span></span><span class="nv">always</span> @<span class="o">*</span> <span class="nv">begin</span><span class="c1">;</span>
    <span class="ss">(</span><span class="o">*</span> <span class="nv">full_case</span> <span class="o">*</span><span class="ss">)</span>
    <span class="nv">case</span> <span class="ss">(</span><span class="nv">sel</span><span class="ss">)</span>
        <span class="mi">2</span><span class="s1">'</span><span class="s">b00: y = a;</span>
        <span class="mi">2</span><span class="s1">'</span><span class="s">b01: y = b;</span>
        <span class="mi">2</span><span class="s1">'</span><span class="s">b10: y = c;</span>
    <span class="nv">endcase</span>
<span class="k">end</span>
</pre></div>
<p>或者是</p>
<div class="highlight"><pre><span></span><span class="nv">always</span> @<span class="o">*</span> <span class="nv">begin</span>
    <span class="nv">case</span> <span class="ss">(</span><span class="nv">sel</span><span class="ss">)</span>  <span class="o">//</span> <span class="nv">synthesis</span> <span class="nv">full_case</span>
        <span class="mi">2</span><span class="s1">'</span><span class="s">b00: y = a;</span>
        <span class="mi">2</span><span class="s1">'</span><span class="s">b01: y = b;</span>
        <span class="mi">2</span><span class="s1">'</span><span class="s">b10: y = c;</span>
    <span class="nv">endcase</span>
<span class="k">end</span>
</pre></div>
<p>那么就只会生成 1 bit 3-to-1 multiplexers，不会有多余的 latch。</p>
<p>虽然这些指令有好处，但是一定要谨慎使用，而且使用时需要注意：</p>
<ol>
<li>
<p>这些综合指令只对综合工具有用，仿真工具会自动忽略这些指令，所以有可能造成前后仿真不一致的问题</p>
</li>
<li>
<p>有时候使用指令，会适得其反，导致结果面积变大、速度变慢</p>
</li>
<li>
<p>一般有迷信的说法：&ldquo; 使用 full case 指令，可以消除 latch。&rdquo; 这个说法太绝对了，事实上并不总是这样。如果有多个输出需要赋值，而有些分支只忽略了一些赋值，那么即使使用 full_case 指令，也不能避免 latch 的产生。</p>
<p>举例，在下面的例子中，仍然会产生 latch</p>
<div class="highlight"><pre><span></span><span class="nv">always</span> @<span class="o">*</span> <span class="nv">begin</span>
    <span class="nv">casez</span> <span class="ss">(</span><span class="nv">sel</span><span class="ss">)</span> <span class="o">//</span> <span class="nv">synthesis</span> <span class="nv">full_case</span>
        <span class="mi">3</span><span class="s1">'</span><span class="s">b100: y1 = 3</span><span class="s1">'</span><span class="nv">b100</span><span class="c1">;</span>
        <span class="mi">3</span><span class="s1">'</span><span class="s">b010: y1 = 3</span><span class="s1">'</span><span class="nv">b010</span><span class="c1">;</span>
        <span class="mi">3</span><span class="s1">'</span><span class="s">b001: y2 = 3</span><span class="s1">'</span><span class="nv">b001</span><span class="c1">;</span>
    <span class="nv">endcase</span>
<span class="k">end</span>
</pre></div>
<p>我们使用 full case 指令的目的就是为了避免生成意外的 latch，但是这种方法有以上的各种弊端。其实还有一种更加简单的方法来避免 latch，就是前面说的，<strong>在 case 前，给所有的输出赋一个默认值。</strong></p>
</li>
</ol>
<p><br/></p>
<h2 id='"parallel" case statement_1'>"parallel" case statement</h2>
<hr/>
<p>"parallel" 的意思就是 expression 的取值每次有且只有一个 item 与其对应，否则就不是 "parallel" case，而匹配的 items 称为 "overlapping" case items。</p>
<h3 id="non-parallel case statements">Non-parallel case statements</h3>
<div class="highlight"><pre><span></span><span class="nv">always</span> @<span class="nv">sel</span> <span class="nv">begin</span>
    <span class="nv">casez</span> <span class="ss">(</span><span class="nv">sel</span><span class="ss">)</span>
        <span class="mi">3</span><span class="s1">'</span><span class="s">b1??: y = 3</span><span class="s1">'</span><span class="nv">b100</span><span class="c1">;</span>
        <span class="mi">3</span><span class="s1">'</span><span class="s">b?1?: y = 3</span><span class="s1">'</span><span class="nv">b010</span><span class="c1">;</span>
        <span class="mi">3</span><span class="s1">'</span><span class="s">b??1: y = 3</span><span class="s1">'</span><span class="nv">b001</span><span class="c1">;</span>
    <span class="nv">endcase</span>
<span class="k">end</span>
</pre></div>
<p>当输入是 3'b011, 3'b101, 3'b110, 3'b111 时，会有多个 item 与 expression 对应，所以不是 parallel 的，会综合出一个 priority encoder。</p>
<h3 id="parallel case statements">Parallel case statements</h3>
<p>对上面的例子稍微修改一下，就得到了 parallel case：</p>
<div class="highlight"><pre><span></span><span class="nv">always</span> @<span class="nv">sel</span> <span class="nv">begin</span>
    <span class="nv">casez</span> <span class="ss">(</span><span class="nv">sel</span><span class="ss">)</span>
        <span class="mi">3</span><span class="s1">'</span><span class="s">b1??: y1 = 1</span><span class="s1">'</span><span class="nv">b1</span><span class="c1">;</span>
        <span class="mi">3</span><span class="s1">'</span><span class="s">b01?: y2 = 1</span><span class="s1">'</span><span class="nv">b1</span><span class="c1">;</span>
        <span class="mi">3</span><span class="s1">'</span><span class="s">b001: y3 = 1</span><span class="s1">'</span><span class="nv">b1</span><span class="c1">;</span>
    <span class="nv">endcase</span>
<span class="k">end</span>
</pre></div>
<h3 id="xst parallel case">XST parallel case</h3>
<p>语法同 full case，只需要将 full_case 替换为 parallel_case 即可。如果 case 本来就是 parallel 的，那么这个指令就完全不起作用，只是一些额外的代码。</p>
<p>不要故意使用 Non-parallel case 来推译 priority encoder，这是不好的编程习惯。如果我们的目的就是要生成 priority encoder，应该使用级联的 if-else 语句，这样更能表达意图。</p>
<p>下面的这些 guideline 可以帮助我们避免 case 生成 priority encoder，从而避免前后仿真不一致：</p>
<blockquote>
<p><strong>Guideline:</strong> Code all intentional priority encoders using if-else-if statements. It is easier for a typical design engineer to recognize a priority encoder when it is coded as an if-else-if statement.</p>
<p><strong>Guideline:</strong> Case statements can be used to create tabular coded parallel logic. Coding with case statements is recommended when a truth-table-like structure makes the Verilog code more concise and readable.</p>
<p><strong>Guideline:</strong> Examine all synthesis tool case-statement reports </p>
<p><strong>Guideline:</strong> Change the case statement code, as outlined in the above coding guidelines, whenever the synthesis tool reports that the case statement is not parallel (whenever the synthesis tool reports "no" for "parallel_case")</p>
</blockquote>
<p><br/></p>
<h2 id="synthesis coding styles_1">Synthesis coding styles</h2>
<hr/>
<p>在总结了 full_parallel_case 之后，Cummings 大神给出了建议：</p>
<blockquote>
<p>Sunburst Design Assumption: it is generally a bad coding practice to give the synthesis tool
different information about the functionality of a design than is given to the simulator.</p>
<p>Guideline: In general, do not use "full_case parallel_case" directives with any Verilog case
statements.</p>
<p>Guideline: There are exceptions to the above guideline but you better know what you're doing if
you plan to add "full_case parallel_case" directives to your Verilog code.</p>
<p>Guideline: Educate (or fire) any employee or consultant that routinely adds "full_case
parallel_case" to all case statements in their Verilog code, especially if the project involves the
design of medical diagnostic equipment, medical implants, or detonation logic for thermonuclear
devices!</p>
<p>Guideline: only use full_case parallel_case to optimize onehot FSM designs.</p>
</blockquote>
<p>甚至建议要开除写 full_parallel_case 的员工 ...</p>
<p><br/></p>
<h2 id="summary">Summary</h2>
<hr/>
<p>总结一下所有的 guidelines：</p>
<blockquote>
<p><strong>Guideline:</strong> Exercise caution when coding synthesizable models using the Verilog casez statement</p>
<p><strong>Guideline:</strong> Do not use casex for synthesizable code</p>
<p><strong>Guideline:</strong> In general, do not use "full_case parallel_case" directives with any Verilog case
statements.</p>
<p><strong>Guideline:</strong> There are exceptions to the above guideline but you better know what you're doing if you plan to add "full_case parallel_case" directives to your Verilog code.</p>
<p><strong>Guideline:</strong> Code all intentional priority encoders using if-else-if statements. It is easier for a typical design engineer to recognize a priority encoder when it is coded as an if-else-if statement.</p>
<p><strong>Guideline:</strong> Coding with case statements is recommended when a truth-table-like structure makes the Verilog code more concise and readable.</p>
<p><strong>Guideline:</strong> Examine all synthesis tool case-statement reports.</p>
<p><strong>Guideline:</strong> Change the case statement code, as outlined in the above coding guidelines, whenever the synthesis tool reports that the case statement is not parallel (whenever the synthesis tool reports "no" for "parallel_case").</p>
<p><strong>Guideline:</strong> only use full_case parallel_case to optimize onehot FSM designs.</p>
<p><strong>Coding Style Guideline:</strong> When coding a case statement with "don't cares," use a casez statement and use "?" characters instead of "z" characters in the case items to indicate "don't care" bits.</p>
<p><strong>Guideline:</strong> Educate (or fire) any employee or consultant that routinely adds "full_case parallel_case" to all case statements in their Verilog code.</p>
<p><strong>Conclusion:</strong> "full_case" and "parallel_case" directives are most dangerous when they work! It is better to code a full and parallel case statement than it is to use directives to make up for poor coding practices.</p>
</blockquote>
<p><br/></p>
<h2 id="ref">Ref</h2>
<p><a href="http://www.sunburst-design.com/papers/CummingsSNUG1999Boston_FullParallelCase.pdf">"full_case parallel_case", the Evil Twins of Verilog Synthesis</a></p>
<p><a href="http://www.phei.com.cn/module/goods/wssd_content.jsp?bookid=38848">Verilog 编程艺术</a></p>
  </div>

  <div class="tag-cloud">
    <p>
      <a href="../../tag/case.html">case</a>
    </p>
  </div>


  <div class="neighbors">
    <a class="btn float-left" href="../../posts/book/on_top_of_tides_review.html" title="不想当司机的厨子不是好码农 —— 读《浪潮之巅》">
      <i class="fa fa-angle-left"></i> Previous Post
    </a>
    <a class="btn float-right" href="../../posts/ic/configurable_design.html" title="可配置设计">
      Next Post <i class="fa fa-angle-right"></i>
    </a>
  </div>



    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <ins class="adsbygoogle ads-responsive"
         data-ad-client="ca-pub-1821536199377100"
         data-ad-slot="4843941849"></ins>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({});
    </script>

<!-- Disqus -->
<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'ChienGu';
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>
    Please enable JavaScript to view comments.
</noscript>
<!-- End Disqus -->
</article>

    <footer>
<p>
  &copy;  2020 - This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>
</p>
<p>
Built with <a href="http://getpelican.com" target="_blank">Pelican</a> using <a href="http://bit.ly/flex-pelican" target="_blank">Flex</a> theme
  <span class="footer-separator">|</span>
  Switch to the <a href="javascript:void(0)" onclick="theme.switch(`dark`)">dark</a> | <a href="javascript:void(0)" onclick="theme.switch(`light`)">light</a> | <a href="javascript:void(0)" onclick="theme.switch(`browser`)">browser</a> theme
  <script id="dark-theme-script"
          src="../../theme/dark-theme/dark-theme.min.js"
          data-enable-auto-detect-theme="True"
          data-default-theme="ligtht"
          type="text/javascript">
  </script>
</p><p>
  <a rel="license"
     href="http://creativecommons.org/licenses/by-sa/4.0/"
     target="_blank">
    <img alt="Creative Commons License"
         title="Creative Commons License"
         style="border-width:0"
           src="https://i.creativecommons.org/l/by-sa/4.0/80x15.png"
         width="80"
         height="15"/>
  </a>
</p>    </footer>
  </main>




<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " Qian's Blog ",
  "url" : "../..",
  "image": "/images/logo.png",
  "description": "Qian's Thoughts and Writings"
}
</script>
<a href="https://github.com/guqian110/guqian110.github.io" class="github-corner" aria-label="View source on Github">
    <svg width="80"
         height="80"
         viewBox="0 0 250 250"
         style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;"
         aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor"
              style="transform-origin: 130px 106px;"
              class="octo-arm">
        </path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor"
              class="octo-body">
        </path>
    </svg>
</a>
<style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
    <script>
      $(document).ready(function() {
        $('#tipue_search_input').tipuesearch();
      });
    </script>

</body>
</html>